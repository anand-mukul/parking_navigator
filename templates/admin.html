{% extends "base.html" %}

{% block content %}
<h2 class="mb-4">⚙️ Admin Dashboard</h2>

<!-- Quick Stats -->
<div class="row mb-4">
  <div class="col-md-3">
    <div class="card text-center shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Total Areas</h5>
        <h2 class="text-primary">{{ stats.total_areas }}</h2>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Total Capacity</h5>
        <h2 class="text-info">{{ stats.total_capacity }}</h2>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Occupied</h5>
        <h2 class="text-warning">{{ stats.total_occupied }}</h2>
      </div>
    </div>
  </div>
  <div class="col-md-3">
    <div class="card text-center shadow-sm">
      <div class="card-body">
        <h5 class="card-title">Available</h5>
        <h2 class="text-success">{{ stats.total_available }}</h2>
      </div>
    </div>
  </div>
</div>

<!-- Add New Area Button -->
<div class="mb-3">
  <a href="{{ url_for('admin.add_area') }}" class="btn btn-success">
    ➕ Add New Parking Area
  </a>
</div>

<!-- Manage Parking Areas -->
{% if areas %}
  {% for area in areas %}
  <div class="card shadow-sm mb-4">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
      <div>
        <h5 class="mb-0">{{ area.name }}</h5>
        <small>📍 {{ area.location }}</small>
      </div>
      <div>
        <a href="{{ url_for('admin.edit_area', area_id=area.id) }}" class="btn btn-sm btn-light">
          ✏️ Edit
        </a>
        <form method="POST" action="{{ url_for('admin.delete_area', area_id=area.id) }}" 
              class="d-inline delete-form">
          <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
          <button type="submit" class="btn btn-sm btn-danger">🗑️ Delete</button>
        </form>
      </div>
    </div>
    
    <div class="card-body">
      <!-- Vehicle Statuses -->
      {% if area.statuses %}
      <table class="table table-sm table-bordered">
        <thead class="table-light">
          <tr>
            <th>Vehicle Type</th>
            <th>Capacity</th>
            <th>Occupied</th>
            <th>Available</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for status in area.statuses %}
          <tr>
            <td>
              {% if status.vehicle_type == 'car' %}🚗{% elif status.vehicle_type == 'bike' %}🏍️{% else %}🚌{% endif %}
              {{ status.vehicle_type.title() }}
            </td>
            <td>{{ status.capacity }}</td>
            <td>
              <span class="badge bg-secondary">{{ status.occupied }}</span>
            </td>
            <td>
              <span class="badge bg-{{ 'success' if status.available_spots() > 0 else 'danger' }}">
                {{ status.available_spots() }}
              </span>
            </td>
            <td>
              <a href="{{ url_for('admin.edit_status', status_id=status.id) }}" 
                 class="btn btn-sm btn-outline-primary">Edit</a>
              <form method="POST" action="{{ url_for('admin.delete_status', status_id=status.id) }}" 
                    class="d-inline delete-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                <button type="submit" class="btn btn-sm btn-outline-danger">Delete</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
      {% else %}
      <p class="text-muted text-center mb-3">No vehicle statuses added yet.</p>
      {% endif %}
      
      <!-- Add Status Button -->
      <a href="{{ url_for('admin.manage_status', area_id=area.id) }}" class="btn btn-sm btn-outline-success">
        ➕ Add Vehicle Status
      </a>
      
      <!-- Last Updated -->
      <small class="text-muted float-end">
        Last updated: {{ area.last_updated.strftime('%Y-%m-%d %H:%M:%S') if area.last_updated else 'Never' }}
      </small>
    </div>
  </div>
  {% endfor %}
{% else %}
  <div class="alert alert-info">
    <h5>No parking areas yet!</h5>
    <p>Click "Add New Parking Area" to get started.</p>
  </div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// Add confirmation for delete forms
document.addEventListener('DOMContentLoaded', function() {
  const deleteForms = document.querySelectorAll('.delete-form');
  deleteForms.forEach(form => {
    form.addEventListener('submit', function(e) {
      const confirmMessage = this.querySelector('button').textContent.includes('Area') 
        ? 'Are you sure you want to delete this parking area? All vehicle statuses will be deleted too.'
        : 'Are you sure you want to delete this vehicle status?';
      
      if (!confirm(confirmMessage)) {
        e.preventDefault();
      }
    });
  });
});
</script>
{% endblock %}